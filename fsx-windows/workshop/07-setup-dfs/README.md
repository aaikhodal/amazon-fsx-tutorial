![](https://s3.amazonaws.com/aws-us-east-1/tutorial/AWS_logo_PMS_300x180.png)

![](https://s3.amazonaws.com/aws-us-east-1/tutorial/100x100_benefit_available.png)![](https://s3.amazonaws.com/aws-us-east-1/tutorial/100x100_benefit_ingergration.png)![](https://s3.amazonaws.com/aws-us-east-1/tutorial/100x100_benefit_ecryption-lock.png)![](https://s3.amazonaws.com/aws-us-east-1/tutorial/100x100_benefit_fully-managed.png)![](https://s3.amazonaws.com/aws-us-east-1/tutorial/100x100_benefit_lowcost-affordable.png)![](https://s3.amazonaws.com/aws-us-east-1/tutorial/100x100_benefit_performance.png)![](https://s3.amazonaws.com/aws-us-east-1/tutorial/100x100_benefit_scalable.png)![](https://s3.amazonaws.com/aws-us-east-1/tutorial/100x100_benefit_storage.png)

# **Amazon FSx for Windows File Server**

## Setup DFS

### Version 2019.04

fsx.w.wrkshp.2019.04

---

Errors or corrections? Email us at [darrylo@amazon.com](mailto:darrylo@amazon.com).

---
### Step 7.1: Setup a DFS Namespace for consolidation

- From the Amazon EC2 Console, copy the **Public DNS (IPv4)** name of the **Windows DFS Namespace Server 1** instance
- Launch your remote desktop application to log on to this Windows EC2 instance
- Log on to the **Windows DFS Namespace Server 1** instance using following AD credentials

| Username | Password |
| :--- | :--- 
| admin@domain.name (e.g. admin@example.com) | The AWS Managed Active Directory "admin" password was generated by AWS Secrets Manager. It is available from the AWS Secrets Manager Console. Select the secret generated by the CloudFormation stack ("Password-SOMEGUID") and select "Retrieve secret value" from the "Secret Value" section. The secure password is the "secret value". |

- Make a note of the computer name of the instance (e.g. $NSS1 = "EC2AMAZ-")

- From the Amazon EC2 Console, copy the **Public DNS (IPv4)** name of the **Windows DFS Namespace Server 2** instance
- Launch your remote desktop application to log on to this Windows EC2 instance
- Log on to the **Windows DFS Namespace Server 2** instance using following AD credentials

| Username | Password |
| :--- | :--- 
| admin@domain.name (e.g. admin@example.com) | The AWS Managed Active Directory "admin" password was generated by AWS Secrets Manager. It is available from the AWS Secrets Manager Console. Select the secret generated by the CloudFormation stack ("Password-SOMEGUID") and select "Retrieve secret value" from the "Secret Value" section. The secure password is the "secret value". |

- Make a note of the computer name of the instance (e.g. $NSS2 = "EC2AMAZ-")

- From either Namespace Server instance (e.g. NSS1 or NSS2), complete the following steps

> Complete the following steps logged on to one of the namespace instances

- Access the DFS management console. Open the Start menu and type dfsmgmt.msc and print the enter/return key.

- Connect to a new namespace. Select **Action** the choose **New Namespace...**

- Browse and select one of the two namespace servers and choose **Next**.

- Enter the name of the namespace (e.g. corp).

- Set the permissions. Choose **Edit Settings** and set the appropriate permissions based on your requirements. Choose **Next**.

- Leave the default **Domain-based namespace** option selected. 

- Leave the **Enable Windows Server 2008 mode** option selected. 

- Choose **Next**.

- Review the namespace settings and choose **Create**.

- With the newly created namespace selected choose **Action** then **Add Namespace Server...**.

- From the Add Namespace Server window, choose **Browse...** and select the other namespace server.

- Select **Edit Settings...** and set the appropriate permissions based on your requirements. Choose **OK**.

- Context-click the namespace you just created and choose **New Folder...**.

- Enter the name of the folder (e.g. share) and choose **Add...**.

- Enter the DNS name of the file system share in UNC format (e.g. \\fs-0123456789abcdef.example.com\share) and choose OK.

- Use the table below and repeat the steps above for the other shares you created in previous steps. 

| Share name |
| :--- |
| data |
| finance |
| sales |
| marketing |

### Step 7.2: Access the new file shares

- Open **File Explorer**
- Type the UNC path to one of the new namespace (e.g. **\\\\example.com\corp\\**)
- Access all the new shares created above (e.g. \data, \finance, \sales, marketing)
- Can we read and write to all shares?

### Step 7.3: Setup a DFS Replication

> Complete the following steps logged on to one of the namespace instances

- These steps will setup DFS replication, replicating the default file share (\share) of the first file system you created to the second file system you created from the restore.

- Open a **PowerShell** window as an **Administrator**

- Create a DFS replication group and folder

```sh
$Group = "Group" # e.g. "ReplicationGroup"
$Folder = "Folder" # e.g. "folder"

New-DfsReplicationGroup -GroupName ${Group}
Grant-DfsrDelegation -GroupName ${Group} –AccountName "FSxAdmins" –Force
New-DfsReplicatedFolder -GroupName ${Group} -FolderName ${Folder}

```


- Determine the Active Directory computer name associated with the write file system and the first read file system.

```sh
$FirstFSDnsName = "DNS Name of the source file system" # e.g. "fs-abcdef0123456789.example.com"
$RestoredFSDnsName = "DNS Name of the restored file system" # e.g. "fs-0123456789abcdef.example.com"
$FirstFSComputerName = (Resolve-DnsName ${FirstFSDnsName} -Type CNAME).NameHost
$RestoredFSComputerName = (Resolve-DnsName ${RestoredFSDnsName} -Type CNAME).NameHost

```


- Add your two file systems as members of the DFS Replication group.

```sh
Add-DfsrMember -GroupName ${Group} -ComputerName ${FirstFSComputerName}
Add-DfsrMember -GroupName ${Group} -ComputerName ${RestoredFSComputerName}

```


- Add the local path of the default file share (e.g. D:\share) for each file system to the DFS Replication group. In this workshop, the first file system will serve as the primary member, meaning that its contents will initially be synced to the restored file system.



```sh
$FirstFSReplicationPath = "D:\Share"
$RestoredFSReplicationPath = "D:\Share"

Set-DfsrMembership –GroupName ${Group} –FolderName ${Folder} –ContentPath ${FirstFSReplicationPath} –ComputerName ${FirstFSComputerName} –PrimaryMember $True -Force
Set-DfsrMembership –GroupName ${Group} –FolderName ${Folder} –ContentPath ${RestoredFSReplicationPath} –ComputerName ${RestoredFSComputerName} –PrimaryMember $False -Force

```


- Add a connection between the file shares.

```sh
Add-DfsrConnection -GroupName ${Group} -SourceComputerName ${FirstFSComputerName} -DestinationComputerName ${RestoredFSComputerName}

```

- Map a drive to the default file shares of both file systems
- Open each mapped drive in a separate **File Explorer** window
- It may take 10-15 minutes for replication to start.
- Once the replication is complete, test creating files on one file system and see them get replicated to the other.

---
## Tear-down
### Delele all the resources you created in this workshop

- Delete the CloudFormation stack
---

For feedback, suggestions, or corrections, please email me at [darrylo@amazon.com](mailto:darrylo@amazon.com).

## License Summary

This sample code is made available under a modified MIT license. See the LICENSE file.

